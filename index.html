<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIXEL PALETTE GENERATOR</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
    	.message {
            display: none;
            margin-top: 20px;
        }
      .slider-value {
        display: inline-block;
        width: 50px;
        text-align: center;
      }
      .color-square {
        width: 100px;
        height: 50px;
        display: inline-block;
        margin: 0px;
        text-align: center;
        vertical-align: middle;
        line-height: 50px;
        color: #fff;
      }
      .col.text-center {
  text-align: center;
}
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <!-- Header Title -->
      <div class="row mb-4">
        <div class="col text-center">
          <h1>PIXEL PALETTE GENERATOR</h1>
        </div>
      </div>
      

<div class="container mt-5 ">
  <div class="row justify-content-center">
    <div class="col-md-auto">
      <label for="colorPicker" class="form-label">Select a middle tone</label>
      <input type="color" class="form-control form-control-color" id="colorPicker" title="Choose your color" onchange="updateColorSquares()" style="width: 100px; height: 100px;" value="#563d7c">
    </div>
  </div>
</div>

      
<div class="container mt-5">
    <div class="row justify-content-center align-items-center mb-3">
            <div class="col-md-2">
                <label for="hueSlider" class="form-label">Hue</label>
            </div>
            <div class="col-md-4">
                <input type="range" class="form-range" id="hueSlider" min="-180" max="180" value="0" oninput="updateValue('hueValue', this.value); updateColorSquares()" style="width: 300px;">
            </div>
            <div class="col-md-1">
                <span id="hueValue" class="slider-value">0</span>
            </div>
            <div class="col-md-3 ">
                <button class="btn btn-primary" onclick="resetSlider('hueSlider', 0, 'hueValue')">Reset</button>
            </div>
        </div>
   

    <div class="row justify-content-center align-items-center mb-3">
      <div class="col-md-2">
        <label for="endSlider" class="form-label">Floor</label>
      </div>
      <div class="col-md-4">
        <input type="range" class="form-range" id="endSlider" min="0" max="100" value="20" oninput="updateValue('endValue', this.value); updateColorSquares()" style="width: 300px;">
      </div>
      <div class="col-md-1">
        <span id="endValue" class="slider-value">20</span>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary" onclick="resetSlider('endSlider', 100, 'endValue')">Reset</button>
      </div>
    </div>

    <div class="row justify-content-center align-items-center mb-3">
      <div class="col-md-2">
        <label for="satShiftSlider" class="form-label">Saturation shift</label>
      </div>
      <div class="col-md-4">
        <input type="range" class="form-range" id="satShiftSlider" min="-45" max="45" value="-10" oninput="updateValue('satShiftValue', this.value); updateColorSquares()" style="width: 300px;">
      </div>
      <div class="col-md-1">
        <span id="satShiftValue" class="slider-value">-10</span>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary" onclick="resetSlider('satShiftSlider', 0, 'satShiftValue')">Reset</button>
      </div>
    </div>

    <div class="row justify-content-center align-items-center mb-3">
      <div class="col-md-2">
        <label for="hueShiftSlider" class="form-label">Hue shift</label>
      </div>
      <div class="col-md-4">
        <input type="range" class="form-range" id="hueShiftSlider" min="-45" max="45" value="5" oninput="updateValue('hueShiftValue', this.value); updateColorSquares()" style="width: 300px;">
      </div>
      <div class="col-md-1">
        <span id="hueShiftValue" class="slider-value">5</span>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary" onclick="resetSlider('hueShiftSlider', 0, 'hueShiftValue')">Reset</button>
      </div>
    </div>

    <div class="row justify-content-center align-items-center mb-3">
      <div class="col-md-2">
        <label for="numColorsSlider" class="form-label"># colors</label>
      </div>
      <div class="col-md-4">
        <input type="range" class="form-range" id="numColorsSlider" min="3" max="15" step="2" value="5" oninput="updateValue('numColorsValue', this.value); updateColorSquares()" style="width: 300px;">
      </div>
      <div class="col-md-1">
        <span id="numColorsValue" class="slider-value">5</span>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary" onclick="resetSlider('numColorsSlider', 5, 'numColorsValue')">Reset</button>
      </div>
    </div>
  </div>
      
      <!-- Color Squares Space (First) -->
      <div class="row mb-4">
        <div class="col text-center" id="colorSquares1">
          <!-- Color squares will be dynamically generated here -->
        </div>
      </div>
      
      <!-- Button Bar -->
      <div class="row mb-4">
        <div class="col text-center">
          <button id="addButton" type="button" class="btn btn-primary mx-2" onclick="addColors()">ADD</button>
          <button id="saveButton" type="button" class="btn btn-success mx-2" onclick="saveGPL()" disabled>SAVE PALETTE (.GPL)</button>
          <div id="message" class="message">Saved to download directory.</div>

        </div>

      </div>
      
      <!-- Color Squares Space (Second) -->
      <div class="row mb-4">
        <div class="col text-center" id="colorSquares2">
          <!-- Color squares will be dynamically generated here -->
        </div>
      </div>
    </div>

	  	    <!-- Footer -->
	    <footer class="text-center mt-4 py-4">
	        <p>Made by 
	            <a href="https://x.com/GonzaloLetterer" target="_blank"> @GonzaloLetterer </a>
	        </p>
	    </footer>
    
    <script>


    	function saveGPL(){
    		var name = generateRandomString();
    		var gplString = generateGPL(getSavedColors(), name);

		    const blob = new Blob([gplString], { type: 'text/plain' });
		    const link = document.createElement('a');
		    link.href = URL.createObjectURL(blob);
		    link.download = "Color palette " + name + ".gpl";
		    document.body.appendChild(link);
		    link.click();
		    document.body.removeChild(link);

		    const messageElement = document.getElementById('message');
		    showMessage(messageElement);
    	}

    	function resetSlider(sliderId, value, valueId) {
    		const slider = document.getElementById(sliderId);
    		slider.value = value;
    		updateValue(valueId, value);
    		updateColorSquares();
    	}

    	function rgbToHsv(r, g, b) {
    		r /= 255;
    		g /= 255;
    		b /= 255;

    		let max = Math.max(r, g, b), min = Math.min(r, g, b);
    		let h, s, v = max;

    		let d = max - min;
    		s = max === 0 ? 0 : d / max;

    		if (max === min) {
          h = 0; // achromatic
      } else {
      	switch(max) {
      	case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      	case g: h = (b - r) / d + 2; break;
      	case b: h = (r - g) / d + 4; break;
      	}
      	h /= 6;
      }

      return [ h * 360, s * 100, v * 100 ];
  }

  function hsvToHex(h, s, v) {
  	let r, g, b;

  	h /= 360;
  	s /= 100;
  	v /= 100;

  	let i = Math.floor(h * 6);
  	let f = h * 6 - i;
  	let p = v * (1 - s);
  	let q = v * (1 - f * s);
  	let t = v * (1 - (1 - f) * s);

  	switch (i % 6) {
  	case 0: r = v, g = t, b = p; break;
  	case 1: r = q, g = v, b = p; break;
  	case 2: r = p, g = v, b = t; break;
  	case 3: r = p, g = q, b = v; break;
  	case 4: r = t, g = p, b = v; break;
  	case 5: r = v, g = p, b = q; break;
  	}

  	return `#${((1 << 24) + (Math.round(r * 255) << 16) + (Math.round(g * 255) << 8) + Math.round(b * 255)).toString(16).slice(1).toUpperCase()}`;
  }

  function updateValue(id, value) {
  	document.getElementById(id).textContent = value;
  }

  function getSavedColors() {
  	var colors = document.getElementById('colorSquares2').textContent;
  	const trimmedString = colors.trim();
  	const colorArray = colors.match(/#[0-9A-Fa-f]{6}/g);
  	return colorArray;
  }

  function generateGPL(colors, paletteName) {
  	let gplContent = `GIMP Palette\n#Palette Name: ${paletteName}\n#Description: Created by PIXEL PALETTE GENERATOR\n#\n`;

  	colors.forEach(color => {
  		const r = parseInt(color.slice(1, 3), 16);
  		const g = parseInt(color.slice(3, 5), 16);
  		const b = parseInt(color.slice(5, 7), 16);
  		gplContent += `${r} ${g} ${b} ${color}\n`;
  	});

  	return gplContent;
  }


  function addColors(){
  	const colorSquares1 = document.getElementById('colorSquares1');
  	const colorSquares2 = document.getElementById('colorSquares2');
  	colorSquares2.innerHTML += colorSquares1.innerHTML + "</br>";
  	document.getElementById('saveButton').disabled = false;
  }

  function updateColorSquares() {
  	const numColors = parseInt(document.getElementById('numColorsSlider').value);
  	const hueOffset = parseInt(document.getElementById('hueSlider').value);
  	const end = parseInt(document.getElementById('endSlider').value);
  	const satShift = parseInt(document.getElementById('satShiftSlider').value);
  	const hueShift = parseInt(document.getElementById('hueShiftSlider').value);
  	const colorPicker = document.getElementById('colorPicker').value;
  	const colorSquares1 = document.getElementById('colorSquares1');
  	colorSquares1.innerHTML = '';
  	const middleIndex = Math.floor(numColors / 2);
  	const baseColor = hexToRgb(colorPicker);
  	const hsvValue = rgbToHsv(baseColor[0], baseColor[1], baseColor[2]);

  	for (let i = 0; i < numColors; i++) {
      		//baseColor here is rgb
  		let hueValue = hsvValue[0]  + (i - middleIndex) * hueShift + hueOffset;
  		if (hueValue > 360) hueValue -= 360;
  		if (hueValue < 0) hueValue += 360;
  		let saturationValue = hsvValue[1] + (i - middleIndex) * satShift; 
  		if (saturationValue > 100) saturationValue = 100;
  		if (saturationValue < 0) saturationValue = 0;
  		var middleValue = hsvValue[2];
			var floorValue = end; // Mirror value
			var step = (middleValue - floorValue) / ((numColors - 1) / 2); // Step size calculation
			let levelValue;
			if (i < middleIndex) {
				levelValue = floorValue + step * i;
			} else if (i == middleIndex) {
				levelValue = middleValue;
			} else {
				levelValue = floorValue + step * i;
			}
			if (levelValue > 100) levelValue = 100;
			if (levelValue < 0) levelValue = 0; 		
			var newColor = hsvToHex(hueValue, saturationValue, levelValue);
			//console.log(newColor);
			colorSquares1.innerHTML += `<div class="color-square" style="background-color: ${newColor};"><div class="color-code">${newColor}</div></div>`;

		}
	}

	function generateRandomString(length = 10) {
		const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		let result = '';
		for (let i = 0; i < length; i++) {
			const randomIndex = Math.floor(Math.random() * characters.length);
			result += characters[randomIndex];
		}
		return result;
	}

	function hexToRgb(hex) {
		const bigint = parseInt(hex.slice(1), 16);
		const r = (bigint >> 16) & 255;
		const g = (bigint >> 8) & 255;
		const b = bigint & 255;
		return [r, g, b];
	}

	function rgbToHex(r, g, b) {
		return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;
	}
	function generateRandomColor() {
		const letters = '0123456789ABCDEF';
		let color = '#';
		for (let i = 0; i < 6; i++) {
			color += letters[Math.floor(Math.random() * 16)];
		}
		return color;
	}

	function showMessage(messageElement) {
    messageElement.style.display = 'block';
    setTimeout(() => {
        messageElement.style.display = 'none';
    }, 2000); 
}

      // Initialize the color squares
	updateColorSquares();
    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
